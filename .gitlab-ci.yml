#image: dumux-precice:3.3git-iterative-pr-2.2.0
#image: dumux-precice:3.3-2.2.1
image: ub2004-style-check:clang-10


stages:
    - check
    - build
    - test

check-style-clang-10:
    stage: check
    script:
        - ./scripts/format/run-clang-format.sh
        - git diff > style-patch.diff
        - if [ -s style-patch.diff ]; then echo "Download the style patch as artifact and apply it or run ./scripts/format/run-clang-format.sh and commit again."; false; fi
    needs: []
    artifacts:
        when: on_failure
        paths:
            - style-patch.diff
        expire_in: 2 days

.build_template: &build-iterative-coupling
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=./test/cmake-test.opts all
    - cd build-cmake/test/partitioned/flow-over-square-2d
    - make -j2 test_ff_flow_over_square_2d test_pm_flow_over_square_2d
  artifacts:
    expire_in: 3 hours
    paths:
      - build-cmake/

build-iterative-coupling:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *build-iterative-coupling
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

build-iterative-coupling:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *build-iterative-coupling

build-iterative-coupling:master-2.2.1:
  image: dumux-precice:master-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  <<: *build-iterative-coupling
  allow_failure: true

.build_template: &build-monolithic-coupling
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    #- dunecontrol --only=dumux-precice --opts=/home/dumux/dumux/dumux/cmake.opts  all
    - dunecontrol --only=dumux-precice --opts=./test/cmake-test.opts  all
    - cd build-cmake/test/monolithic/flow-over-square-2d
    - make -j2 test_ff_pm_flow_over_square_2d
  artifacts:
    expire_in: 3 hours
    paths:
      - build-cmake/

build-monolithic-coupling:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *build-monolithic-coupling
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

build-monolithic-coupling:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *build-monolithic-coupling

build-monolithic-coupling:master-2.2.1:
  image: dumux-precice:master-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  <<: *build-monolithic-coupling
  allow_failure: true


.test_template: &test-iterative-coupling
  stage: test
  script:
    - cd build-cmake/test/partitioned/flow-over-square-2d
    - CTEST_OUTPUT_ON_FAILURE=1 ctest --verbose
  artifacts:
    expire_in: 2 days
    when: on_failure
    paths:
      - build-cmake/


test-iterative-coupling:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *test-iterative-coupling
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-iterative-coupling:3.3-2.2.1

test-iterative-coupling:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *test-iterative-coupling
  needs:
    - build-iterative-coupling:3.4-2.2.1

test-iterative-coupling:master-2.2.1:
  image: ub2004-dumux-precice:master-2.2.1
  <<: *test-iterative-coupling
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-iterative-coupling:master-2.2.1
  allow_failure: true

.test_template: &test-monolithic-coupling
  stage: test
  script:
    - cd build-cmake/test/monolithic/flow-over-square-2d
    - CTEST_OUTPUT_ON_FAILURE=1 ctest
  artifacts:
    expire_in: 2 days
    paths:
      - build-cmake/

test-monolithic-coupling:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *test-monolithic-coupling
  needs:
    - build-monolithic-coupling:3.3-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

test-monolithic-coupling:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *test-monolithic-coupling
  needs:
    - build-monolithic-coupling:3.4-2.2.1

test-monolithic-coupling:master-2.2.1:
  image: ub2004-dumux-precice:master-2.2.1
  <<: *test-monolithic-coupling
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-monolithic-coupling:master-2.2.1
  allow_failure: true

.build_template: &build-monolithic-flow-over-step-2d
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=./test/cmake-test.opts  all
    - cd build-cmake/examples/ff-pm/monolithic/flow-over-step-2d
    - make -j2 flow-over-step-2d
  artifacts:
    expire_in: 3 hours
    paths:
      - build-cmake/

build-monolithic-flow-over-step-2d:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *build-monolithic-flow-over-step-2d
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

build-monolithic-flow-over-step-2d:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *build-monolithic-flow-over-step-2d
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

build-monolithic-flow-over-step-2d:master-2.2.1:
  image: dumux-precice:master-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  <<: *build-monolithic-flow-over-step-2d
  allow_failure: true

.test_template: &test-monolithic-flow-over-step-2d
  stage: test
  script:
    - cd build-cmake/examples/ff-pm/monolithic/flow-over-step-2d/
    - CTEST_OUTPUT_ON_FAILURE=1 ctest
  artifacts:
    when: on_failure
    expire_in: 2 days
    paths:
      - build-cmake/

test-monolithic-flow-over-step-2d:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *test-monolithic-flow-over-step-2d
  needs:
    - build-monolithic-flow-over-step-2d:3.3-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

test-monolithic-flow-over-step-2d:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *test-monolithic-flow-over-step-2d
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-monolithic-flow-over-step-2d:3.4-2.2.1

test-monolithic-flow-over-step-2d:master-2.2.1:
  image: ub2004-dumux-precice:master-2.2.1
  <<: *test-monolithic-flow-over-step-2d
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-monolithic-flow-over-step-2d:master-2.2.1
  allow_failure: true

.build_template: &build-monolithic-ff-pm-3d
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=./test/cmake-test.opts  all
    - cd build-cmake/examples/ff-pm/monolithic/ff-pm-3d
    - make -j2 ff-pm-3d
  artifacts:
    expire_in: 3 hours
    paths:
      - build-cmake/

build-monolithic-ff-pm-3d:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *build-monolithic-ff-pm-3d
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

build-monolithic-ff-pm-3d:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *build-monolithic-ff-pm-3d
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

build-monolithic-ff-pm-3d:master-2.2.1:
  image: dumux-precice:master-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  <<: *build-monolithic-ff-pm-3d
  allow_failure: true


.test_template: &test-monolithic-ff-pm-3d
  stage: test
  script:
    - cd build-cmake/examples/ff-pm/monolithic/ff-pm-3d/
    - CTEST_OUTPUT_ON_FAILURE=1 ctest
  artifacts:
    expire_in: 2 days
    when: on_failure
    paths:
      - build-cmake/
  needs:
    - build:monolithic:ff-pm-3d

test-monolithic-ff-pm-3d:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *test-monolithic-ff-pm-3d
  needs:
    - build-monolithic-ff-pm-3d:3.3-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

test-monolithic-ff-pm-3d:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *test-monolithic-ff-pm-3d
  needs:
    - build-monolithic-ff-pm-3d:3.4-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

test-monolithic-ff-pm-3d:master-2.2.1:
  image: ub2004-dumux-precice:master-2.2.1
  <<: *test-monolithic-ff-pm-3d
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-monolithic-ff-pm-3d:master-2.2.1
  allow_failure: true
