image: ajaust/style-check:0.2

stages:
    - check
    - build
    - test

check-style-clang-10:
    stage: check
    script:
        - ./scripts/format/run-clang-format.sh > clang-format-output.txt
        - if [ -s clang-format-output.txt ]; then cat clang-format-output.txt; echo "Some files need reformatting. Check the output and run ./scripts/format/run-clang-format.sh and commit again."; false; fi
    needs: []
    artifacts:
        when: on_failure
        paths:
            - style-patch.diff
        expire_in: 2 days

check-style-black:
    stage: check
    script:
        - pip install --user black
        - black .
    needs: []

check-style-markdownlint:
    stage: check
    script:
        - sudo gem install mdl
        - mdl .
    needs: []

.build_template: &build-tests
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=./test/cmake-test.opts all
    - cd build-cmake/
    - make -j2 build_tests
  artifacts:
    expire_in: 3 hours
    paths:
      - build-cmake/

build-tests:3.3-2.2.1:
  image: ajaust/dumux-precice:3.3-2.2.1
  <<: *build-tests
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'

build-tests:3.4-2.2.1:
  image: ajaust/dumux-precice:3.4-2.2.1
  <<: *build-tests

build-tests:3.4-2.3.0:
  image: ajaust/dumux-precice:3.4-2.3.0
  <<: *build-tests

build-tests:master-2.2.1:
  image: ajaust/dumux-precice:master-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  <<: *build-tests
  allow_failure: true

.test_template: &test-partitioned-cases
  stage: test
  script:
    - cd build-cmake/
    - CTEST_OUTPUT_ON_FAILURE=1 ctest -j1 -L ^partitioned$
  artifacts:
    expire_in: 2 days
    when: on_failure
    paths:
      - build-cmake/

test-partitioned:3.3-2.2.1:
  image: ajaust/dumux-precice:3.3-2.2.1
  <<: *test-partitioned-cases
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-iterative-coupling:master-2.2.1
  allow_failure: true

.test_template: &test-monolithic-coupling
  stage: test
  script:
    - cd build-cmake/appl/coupling-ff-pm/fvca-monolithic/
    - - CTEST_OUTPUT_ON_FAILURE=1 ctest
  artifacts:
    expire_in: 5 days
    paths:
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic/Testing/Temporary/LastTest.log
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic/Testing/Temporary/LastTestsFailed.log

test-partitioned:3.4-2.2.1:
  image: ajaust/dumux-precice:3.4-2.2.1
  <<: *test-partitioned-cases
  needs:
    - build-tests:3.4-2.2.1

test-partitioned:3.4-2.3.0:
  image: ajaust/dumux-precice:3.4-2.3.0
  <<: *test-partitioned-cases
  needs:
    - build-tests:3.4-2.3.0

test-partitioned:master-2.2.1:
  image: ajaust/dumux-precice:master-2.2.1
  <<: *test-partitioned-cases
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-monolithic-coupling:master-2.2.1
  allow_failure: true

.build_template: &build-monolithic-flow-over-step-2d
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    #- dunecontrol --only=dumux-precice --opts=/home/dumux/dumux/dumux/cmake.opts  all
    - dunecontrol --only=dumux-precice --opts=./test/cmake-test.opts  all
    - cd build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d
    - make -j2 flow-over-step-2d
  artifacts:
    expire_in: 3 days
    paths:
      - build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d/flow-over-step-2d
      - build-cmake/CMakeFiles/CMakeError.log
      - build-cmake/CMakeFiles/CMakeOutput.log
      - build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d/Makefile
      - build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d/CTestTestfile.cmake

build-monolithic-flow-over-step-2d:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *build-monolithic-flow-over-step-2d

build-monolithic-flow-over-step-2d:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *build-monolithic-flow-over-step-2d

build-monolithic-flow-over-step-2d:master-2.2.1:
  image: dumux-precice:master-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  <<: *build-monolithic-flow-over-step-2d
  allow_failure: true

.test_template: &test-monolithic-flow-over-step-2d
  stage: test
  script:
    - cd build-cmake
    - echo $PYTHONPATH
    - CTEST_OUTPUT_ON_FAILURE=1 ctest -j2 -L ^monolithic$
  artifacts:
    expire_in: 2 days
    when: on_failure
    paths:
      - build-cmake/

test-monolithic:3.3-2.2.1:
  image: ajaust/dumux-precice:3.3-2.2.1
  <<: *test-monolithic-cases
  needs:
    - build-tests:3.3-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-monolithic-flow-over-step-2d:master-2.2.1
  allow_failure: true

.build_template: &build-monolithic-ff-pm-3d
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    #- dunecontrol --only=dumux-precice --opts=/home/dumux/dumux/dumux/cmake.opts  all
    - dunecontrol --only=dumux-precice --opts=./test/cmake-test.opts  all
    - cd build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d
    - make -j2 ff-pm-3d
  artifacts:
    expire_in: 3 days
    paths:
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/ff-pm-3d
      - build-cmake/CMakeFiles/CMakeError.log
      - build-cmake/CMakeFiles/CMakeOutput.log
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/Makefile
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/CTestTestfile.cmake

build-monolithic-ff-pm-3d:3.3-2.2.1:
  image: ub2004-dumux-precice:3.3-2.2.1
  <<: *build-monolithic-ff-pm-3d

build-monolithic-ff-pm-3d:3.4-2.2.1:
  image: ub2004-dumux-precice:3.4-2.2.1
  <<: *build-monolithic-ff-pm-3d

build-monolithic-ff-pm-3d:master-2.2.1:
  image: dumux-precice:master-2.2.1
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  <<: *build-monolithic-ff-pm-3d
  allow_failure: true


.test_template: &test-monolithic-ff-pm-3d
  stage: test
  script:
    - cd build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/
    - - CTEST_OUTPUT_ON_FAILURE=1 ctest
  artifacts:
    expire_in: 2 days
    when: on_failure
    paths:
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/Testing/Temporary/LastTest.log
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/Testing/Temporary/LastTestsFailed.log
  needs:
    - build:monolithic:ff-pm-3d

test-monolithic:3.4-2.2.1:
  image: ajaust/dumux-precice:3.4-2.2.1
  <<: *test-monolithic-cases
  needs:
    - build-tests:3.4-2.2.1

test-monolithic:3.4-2.3.0:
  image: ajaust/dumux-precice:3.4-2.3.0
  <<: *test-monolithic-cases
  needs:
    - build-tests:3.4-2.3.0

test-monolithic:master-2.2.1:
  image: ajaust/dumux-precice:master-2.2.1
  <<: *test-monolithic-cases
  rules:
    - if: '$CI_NIGHTLY_BUILD == "TRUE"'
  needs:
    - build-monolithic-ff-pm-3d:master-2.2.1
  allow_failure: true
