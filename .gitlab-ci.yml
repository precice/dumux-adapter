image: dumux-precice:3.3git-iterative-pr-1.6.1
#image: dumux-precice:3.1-1.6.1

stages:
    - check
    - build
    - test
    
check-style:
    stage: check
    script:
        - ./scripts/format/run-clang-format.sh
        - git diff > style-patch.diff
        - if [ -s style-patch.diff ]; then echo "Download the style patch as artifact and apply it or run ./scripts/format/run-clang-format.sh and commit again."; false; fi
    needs: []
    artifacts:
        paths:
            - style-patch.diff
        expire_in: 7 day

build:iterative-coupling:
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=./test/cmake-test.opts all
    - cd build-cmake/appl/coupling-ff-pm/iterative-reversed/
    - make -j2 test_ff_reversed test_pm_reversed
  artifacts:
    expire_in: 3 days
    paths:
      - build-cmake/appl/coupling-ff-pm/iterative-reversed/test_ff_reversed
      - build-cmake/appl/coupling-ff-pm/iterative-reversed/test_pm_reversed
      - build-cmake/CMakeFiles/CMakeError.log
      - build-cmake/CMakeFiles/CMakeOutput.log
      - build-cmake/appl/coupling-ff-pm/iterative-reversed/Makefile
      - build-cmake/appl/coupling-ff-pm/iterative-reversed/CTestTestfile.cmake

test:iterative-coupling:
  stage: test
  script:
    - cd build-cmake/appl/coupling-ff-pm/iterative-reversed/
    - ctest
  artifacts:
    expire_in: 5 days
    paths:
      - build-cmake/appl/coupling-ff-pm/iterative-reversed/Testing/Temporary/LastTest.log
      - build-cmake/appl/coupling-ff-pm/iterative-reversed/Testing/Temporary/LastTestsFailed.log
  needs:
    - build:iterative-coupling

build:monolithic-coupling:
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=/home/dumux/dumux/dumux/cmake.opts  all
    - cd build-cmake/appl/coupling-ff-pm/fvca-monolithic-reversed
    - make -j2 fvca-monolithic-reversed
  artifacts:
    expire_in: 3 days
    paths:
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic-reversed/fvca-monolithic-reversed
      - build-cmake/CMakeFiles/CMakeError.log
      - build-cmake/CMakeFiles/CMakeOutput.log
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic-reversed/Makefile
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic-reversed/CTestTestfile.cmake

test:monolithic-coupling:
  stage: test
  script:
    - cd build-cmake/appl/coupling-ff-pm/fvca-monolithic-reversed/
    - ctest
  artifacts:
    expire_in: 5 days
    paths:
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic-reversed/Testing/Temporary/LastTest.log
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic-reversed/Testing/Temporary/LastTestsFailed.log
  needs:
    - build:monolithic-coupling
