#image: dumux-precice:3.3git-iterative-pr-2.2.0
image: dumux-precice:3.3git-iterative-pr-1.6.1
#image: dumux-precice:3.1-1.6.1

stages:
    - check
    - build
    - test

check-style:
    stage: check
    script:
        - ./scripts/format/run-clang-format.sh
        - git diff > style-patch.diff
        - if [ -s style-patch.diff ]; then echo "Download the style patch as artifact and apply it or run ./scripts/format/run-clang-format.sh and commit again."; false; fi
    needs: []
    artifacts:
        paths:
            - style-patch.diff
        expire_in: 7 day

build:iterative-coupling:
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=./test/cmake-test.opts all
    - cd build-cmake/appl/coupling-ff-pm/fvca-iterative/
    - make -j2 fvca-iterative-ff fvca-iterative-pm
  artifacts:
    expire_in: 3 days
    paths:
      - build-cmake/appl/coupling-ff-pm/fvca-iterative/fvca-iterative-ff
      - build-cmake/appl/coupling-ff-pm/fvca-iterative/fvca-iterative-pm
      - build-cmake/CMakeFiles/CMakeError.log
      - build-cmake/CMakeFiles/CMakeOutput.log
      - build-cmake/appl/coupling-ff-pm/fvca-iterative/Makefile
      - build-cmake/appl/coupling-ff-pm/fvca-iterative/CTestTestfile.cmake

test:iterative-coupling:
  stage: test
  script:
    - cd build-cmake/appl/coupling-ff-pm/fvca-iterative/
    - ctest
  artifacts:
    expire_in: 5 days
    paths:
      - build-cmake/appl/coupling-ff-pm/fvca-iterative/Testing/Temporary/LastTest.log
      - build-cmake/appl/coupling-ff-pm/fvca-iterative/Testing/Temporary/LastTestsFailed.log
  needs:
    - build:iterative-coupling

build:monolithic-coupling:
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - ls
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=/home/dumux/dumux/dumux/cmake.opts  all
    - cd build-cmake/appl/coupling-ff-pm/fvca-monolithic
    - make -j2 fvca-monolithic
  artifacts:
    expire_in: 3 days
    paths:
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic/fvca-monolithic
      - build-cmake/CMakeFiles/CMakeError.log
      - build-cmake/CMakeFiles/CMakeOutput.log
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic/Makefile
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic/CTestTestfile.cmake

test:monolithic-coupling:
  stage: test
  script:
    - cd build-cmake/appl/coupling-ff-pm/fvca-monolithic/
    - ctest
  artifacts:
    expire_in: 5 days
    paths:
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic/Testing/Temporary/LastTest.log
      - build-cmake/appl/coupling-ff-pm/fvca-monolithic/Testing/Temporary/LastTestsFailed.log
  needs:
    - build:monolithic-coupling

build:monolithic:flow-over-step-2d:
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=/home/dumux/dumux/dumux/cmake.opts  all
    - cd build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d
    - make -j2 flow-over-step-2d
  artifacts:
    expire_in: 3 days
    paths:
      - build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d/flow-over-step-2d
      - build-cmake/CMakeFiles/CMakeError.log
      - build-cmake/CMakeFiles/CMakeOutput.log
      - build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d/Makefile
      - build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d/CTestTestfile.cmake

test:monolithic:flow-over-step-2d:
  stage: test
  script:
    - cd build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d/
    - ctest
  artifacts:
    expire_in: 5 days
    paths:
      - build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d/Testing/Temporary/LastTest.log
      - build-cmake/appl/coupling-ff-pm/monolithic/flow-over-step-2d/Testing/Temporary/LastTestsFailed.log
  needs:
    - build:monolithic:flow-over-step-2d


build:monolithic:ff-pm-3d:
  stage: build
  script:
    - cd ..
    - export DUNE_CONTROL_PATH=${PWD}/dumux-precice:${DUNE_CONTROL_PATH}
    - cd dumux-precice/
    - echo $DUNE_CONTROL_PATH
    - dunecontrol --only=dumux-precice --opts=/home/dumux/dumux/dumux/cmake.opts  all
    - cd build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d
    - make -j2 ff-pm-3d
  artifacts:
    expire_in: 3 days
    paths:
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/ff-pm-3d
      - build-cmake/CMakeFiles/CMakeError.log
      - build-cmake/CMakeFiles/CMakeOutput.log
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/Makefile
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/CTestTestfile.cmake

test:monolithic:ff-pm-3d:
  stage: test
  script:
    - cd build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/
    - ctest
  artifacts:
    expire_in: 5 days
    paths:
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/Testing/Temporary/LastTest.log
      - build-cmake/appl/coupling-ff-pm/monolithic/ff-pm-3d/Testing/Temporary/LastTestsFailed.log
  needs:
    - build:monolithic:ff-pm-3d